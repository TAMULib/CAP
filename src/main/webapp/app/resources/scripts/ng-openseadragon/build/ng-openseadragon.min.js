"use strict";angular.module("ui.openseadragon",[]).directive("seadragon",["$timeout",function(o){return{restrict:"E",scope:{options:"=",name:"=",tilesource:"=",prefixUrl:"="},controller:["$scope",function(o){o.osd=null}],link:function(e,n,t){function r(){e.osd&&(e.osd.destroy(),e.osd=null);var r=angular.extend({},e.options,{id:"openseadragon-"+Math.random(),element:n[0]});e.osd=OpenSeadragon(r);var i={mouse:{position:null,imageCoord:null,viewportCoord:null},zoom:0,viewport:{}};for(var a in e.osd)i[a]=e.osd[a];t.name&&(e.$parent[t.name]=i,s=function(n){o(function(){e.$apply(function(){i.zoom=n.zoom})},0)},d=function(o){e.$apply(function(){i.viewportInfo={bounds:e.osd.viewport.getBounds(!1),center:e.osd.viewport.getCenter(!1),rotation:e.osd.viewport.getRotation(),zoom:e.osd.viewport.getZoom(!1)}})},e.osd.addHandler("zoom",s),e.osd.addHandler("update-viewport",d),e.mouse=new OpenSeadragon.MouseTracker({element:e.osd.canvas,enterHandler:function(o){if(e.osd.viewport){var n=OpenSeadragon.getElementPosition(e.osd.canvas),t=o.position.plus(n),r={position:t,imageCoord:e.osd.viewport.windowToImageCoordinates(t),viewportCoord:e.osd.viewport.windowToViewportCoordinates(t)};e.$apply(function(){i.mouse=r})}},moveHandler:function(o){if(e.osd.viewport){var n=OpenSeadragon.getElementPosition(e.osd.canvas),t=o.position.plus(n),r={position:t,imageCoord:e.osd.viewport.windowToImageCoordinates(t),viewportCoord:e.osd.viewport.windowToViewportCoordinates(t)};e.$apply(function(){i.mouse=r})}},exitHandler:function(o){e.$apply(function(){i.mouse.position=null,i.mouse.imageCoord=null,i.mouse.viewportCoord=null})}}),e.mouse.setTracking(!0))}t.tilesource&&(opts.tileSources=[t.tilesource]),t.prefixUrl&&(opts.prefixUrl=t.prefixUrl),r();var i=e.$watch("options",r),s=null,d=null;n.on("$destroy",function(){t.name&&(e.$parent[t.name]=null,e.mouse.destroy(),i(),e.osd.removeHandler("zoom",s),e.osd.removeHandler("update-viewport",d)),e.osd.destroy()})}}}]);